<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Anonymous chat application with multiple themed environments. Connect with people around the world in a safe, anonymous space.">
    <meta name="keywords" content="anonymous chat, chat rooms, anonymous messaging, online chat, social chat">
    <meta name="author" content="AnonChat">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-app-name.netlify.app/">
    <meta property="og:title" content="AnonChat - Anonymous Chatting">
    <meta property="og:description" content="Anonymous chat application with multiple themed environments. Connect with people around the world in a safe, anonymous space.">
    <meta property="og:image" content="https://your-app-name.netlify.app/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-app-name.netlify.app/">
    <meta property="twitter:title" content="AnonChat - Anonymous Chatting">
    <meta property="twitter:description" content="Anonymous chat application with multiple themed environments. Connect with people around the world in a safe, anonymous space.">
    <meta property="twitter:image" content="https://your-app-name.netlify.app/og-image.png">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    
    <title>AnonChat - Anonymous Chatting</title>
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, limit, serverTimestamp, doc, setDoc, deleteDoc, query, getDocs, writeBatch, offset } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // Make Firebase available globally
        window.firebase = {
            initializeApp,
            getFirestore,
            getAuth,
            firestore: {
                collection,
                addDoc,
                onSnapshot,
                orderBy,
                limit,
                serverTimestamp,
                doc,
                setDoc,
                deleteDoc,
                query,
                getDocs,
                writeBatch,
                offset
            }
        };
    </script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b3d 50%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid #dc2626;
            width: 100%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
            overflow: hidden;
        }

        .chat-header {
            background: rgba(30, 30, 30, 0.8);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #3b82f6;
        }

        .chat-header h1 {
            color: white;
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .chat-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }



        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .username {
            font-weight: 600;
            font-size: 0.8rem;
            color: rgba(229, 231, 235, 0.9);
        }

        .timestamp {
            font-size: 0.7rem;
            color: rgba(229, 231, 235, 0.6);
        }

        .message-content {
            background: rgba(50, 50, 50, 0.8);
            padding: 12px 16px;
            border-radius: 18px;
            color: #e5e7eb;
            word-wrap: break-word;
            border: 1px solid #dc2626;
        }

        .message.own .message-content {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
        }

        .input-container {
            padding: 20px;
            background: rgba(40, 40, 40, 0.6);
            border-top: 2px solid #3b82f6;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            background: rgba(60, 60, 60, 0.8);
            border: 2px solid #dc2626;
            border-radius: 25px;
            padding: 12px 20px;
            color: #e5e7eb;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input::placeholder {
            color: rgba(229, 231, 235, 0.6);
        }

        .message-input:focus {
            border-color: #3b82f6;
            background: rgba(70, 70, 70, 0.9);
        }

        .send-button {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.2rem;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
            border: 2px solid #3b82f6;
        }

        .modal-content h2 {
            color: #e5e7eb;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .modal-content p {
            color: #9ca3af;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .username-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dc2626;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s ease;
            background: rgba(60, 60, 60, 0.8);
            color: #e5e7eb;
        }

        .username-input:focus {
            border-color: #3b82f6;
            background: rgba(70, 70, 70, 0.9);
        }

        .join-button {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .join-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.3);
        }

        .system-message {
            text-align: center;
            color: rgba(229, 231, 235, 0.7);
            font-style: italic;
            font-size: 0.85rem;
            margin: 10px 0;
        }

        @media (max-width: 600px) {
            .chat-container {
                height: 90vh;
                margin: 10px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .chat-header h1 {
                font-size: 1.5rem;
            }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(229, 231, 235, 0.7);
            font-style: italic;
            font-size: 0.85rem;
            padding: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: rgba(229, 231, 235, 0.7);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Environment Selection Styles */
        .environments-container {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid #dc2626;
            width: 100%;
            max-width: 1000px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
        }

        .environments-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .environments-header h1 {
            color: #e5e7eb;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .environments-header p {
            color: rgba(229, 231, 235, 0.8);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        /* Search Styles */
        .search-container {
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dc2626;
            border-radius: 25px;
            background: rgba(60, 60, 60, 0.8);
            color: #e5e7eb;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box input::placeholder {
            color: rgba(229, 231, 235, 0.6);
        }

        .search-box input:focus {
            border-color: #3b82f6;
            background: rgba(70, 70, 70, 0.9);
        }

        .search-button {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1rem;
        }

        .search-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .search-results {
            margin-top: 15px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-result-item {
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-result-item:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: #dc2626;
            transform: translateY(-2px);
        }

        .search-result-icon {
            font-size: 1.5rem;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            color: #e5e7eb;
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .search-result-desc {
            color: rgba(229, 231, 235, 0.7);
            font-size: 0.85rem;
        }

        .search-result-id {
            color: #3b82f6;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .no-results {
            text-align: center;
            color: rgba(229, 231, 235, 0.6);
            font-style: italic;
            padding: 20px;
        }

        .environments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .environment-card {
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .environment-card:hover {
            transform: translateY(-5px);
            background: rgba(70, 70, 70, 0.9);
            border-color: #dc2626;
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }

        .environment-card.add-new {
            border: 2px dashed #3b82f6;
            background: rgba(40, 40, 40, 0.6);
        }

        .environment-card.add-new:hover {
            border-color: #dc2626;
            background: rgba(60, 60, 60, 0.8);
        }

        .environment-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .environment-card h3 {
            color: #e5e7eb;
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .environment-card p {
            color: rgba(229, 231, 235, 0.8);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .environment-stats {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .environment-stats .environment-id {
            color: #3b82f6;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .environment-stats .environment-creator {
            color: #dc2626;
            font-size: 0.7rem;
            font-weight: 500;
            background: rgba(220, 38, 38, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .delete-environment-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(220, 38, 38, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.9rem;
            z-index: 10;
        }

        .delete-environment-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        /* Back Button */
        .back-button {
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .back-button:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: #dc2626;
            transform: scale(1.1);
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-content {
            flex: 1;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-button {
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-button:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: #dc2626;
            transform: scale(1.1);
        }

        /* Environment Info Modal */
        .environment-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .environment-info-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
            border: 2px solid #3b82f6;
        }

        .environment-info-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .environment-info-icon {
            font-size: 2.5rem;
        }

        .environment-info-title {
            color: #e5e7eb;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .environment-info-details {
            text-align: left;
            margin-bottom: 25px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(229, 231, 235, 0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: rgba(229, 231, 235, 0.7);
            font-size: 0.9rem;
        }

        .info-value {
            color: #e5e7eb;
            font-weight: 500;
        }

        .environment-info-close {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .environment-info-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }

        /* Create Environment Modal */
        .create-environment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .environment-name-input,
        .environment-desc-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dc2626;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.3s ease;
            font-family: inherit;
            background: rgba(60, 60, 60, 0.8);
            color: #e5e7eb;
        }

        .environment-name-input:focus,
        .environment-desc-input:focus {
            border-color: #3b82f6;
            background: rgba(70, 70, 70, 0.9);
        }

        .environment-desc-input {
            resize: vertical;
            min-height: 80px;
        }

        .emoji-picker {
            margin-bottom: 20px;
        }

        .emoji-picker label {
            display: block;
            color: #e5e7eb;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .emoji-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .emoji-option {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 2px solid #dc2626;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            background: rgba(50, 50, 50, 0.8);
        }

        .emoji-option:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .emoji-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .cancel-button {
            background: rgba(60, 60, 60, 0.8);
            color: #9ca3af;
            border: 2px solid #dc2626;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-button:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: #3b82f6;
        }

        .create-button {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }

        /* Login Styles */
        .login-container {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid #dc2626;
            width: 100%;
            max-width: 450px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
        }

        .login-card {
            text-align: center;
        }

        .login-header h1 {
            color: #e5e7eb;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .login-header p {
            color: rgba(229, 231, 235, 0.8);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .login-content {
            margin-bottom: 30px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .user-avatar img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #3b82f6;
        }

        .user-details {
            flex: 1;
            text-align: left;
        }

        .user-details h3 {
            color: #e5e7eb;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-details p {
            color: rgba(229, 231, 235, 0.7);
            font-size: 0.9rem;
        }

        .logout-button {
            background: linear-gradient(45deg, #dc2626, #3b82f6);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }

        .g_id_signin {
            margin-bottom: 20px;
        }

        .g_id_signin > div {
            width: 100% !important;
        }

        .g_id_signin iframe {
            width: 100% !important;
            height: 48px !important;
        }

        .login-divider {
            position: relative;
            text-align: center;
            margin: 25px 0;
        }

        .login-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(229, 231, 235, 0.3);
        }

        .login-divider span {
            background: rgba(20, 20, 20, 0.9);
            padding: 0 15px;
            color: rgba(229, 231, 235, 0.6);
            font-size: 0.9rem;
        }

        .guest-login {
            margin-top: 20px;
        }

        .guest-login p {
            color: rgba(229, 231, 235, 0.7);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .guest-button {
            background: rgba(60, 60, 60, 0.8);
            color: #e5e7eb;
            border: 2px solid #dc2626;
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .guest-button:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .login-footer {
            margin-top: 30px;
        }

        .login-footer p {
            color: rgba(229, 231, 235, 0.5);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .environments-container {
                padding: 20px;
                margin: 10px;
            }
            
            .environments-grid {
                grid-template-columns: 1fr;
            }
            
            .environments-header h1 {
                font-size: 2rem;
            }
            
            .emoji-options {
                grid-template-columns: repeat(4, 1fr);
            }

            .login-container {
                padding: 30px 20px;
                margin: 10px;
            }

            .login-header h1 {
                font-size: 2rem;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
            }

            .user-details {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Interface -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1>🎭 AnonChat</h1>
                <p>Sign in to start chatting anonymously</p>
            </div>
            
            <div class="login-content">
                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>
                
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar">
                        <img id="userAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-details">
                        <h3 id="userName">User Name</h3>
                        <p id="userEmail">user@email.com</p>
                    </div>
                    <button class="logout-button" id="logoutButton">
                        Sign Out
                    </button>
                </div>
                
                <div class="login-options" id="loginOptions">
                    <div id="g_id_onload"
                         data-client_id="522966423715-bqcif1to9hreso1ulf1q6tifh0rh1mt3.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left"
                         data-width="100%">
                    </div>
                    
                    <div class="login-divider">
                        <span>or</span>
                    </div>
                    
                    <div class="guest-login">
                        <p>Continue as guest (limited features)</p>
                        <button class="guest-button" id="guestButton">
                            Continue as Guest
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <!-- Chat Environment Selection Interface -->
    <div class="environments-container" id="environmentsContainer" style="display: none;">
        <div class="environments-header">
            <h1>🎭 AnonChat</h1>
            <p>Choose your chat environment</p>
            
            <div class="search-container">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="environmentSearch" 
                        placeholder="Search by Environment ID..."
                        maxlength="20"
                    >
                    <button class="search-button" id="searchButton">
                        🔍
                    </button>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        
        <div class="environments-grid" id="environmentsGrid">
            <div class="environment-card" data-environment="geopolitics">
                <div class="environment-icon">🌍</div>
                <h3>Geo Politics</h3>
                <p>Global affairs & political discussions</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: GEO001</span>
                </div>
            </div>
            
            <div class="environment-card" data-environment="science">
                <div class="environment-icon">🔬</div>
                <h3>Science</h3>
                <p>Scientific discoveries & research</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: SCI002</span>
                </div>
            </div>
            
            <div class="environment-card" data-environment="education">
                <div class="environment-icon">📚</div>
                <h3>Education</h3>
                <p>Learning & academic discussions</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: EDU003</span>
                </div>
            </div>
            
            <div class="environment-card" data-environment="programming">
                <div class="environment-icon">💻</div>
                <h3>Programming</h3>
                <p>Code, tech & development</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: PRO004</span>
                </div>
            </div>
            
            <div class="environment-card" data-environment="social-media">
                <div class="environment-icon">📱</div>
                <h3>Social Media</h3>
                <p>Trends & digital culture</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: SOC005</span>
                </div>
            </div>
            
            <div class="environment-card" data-environment="memes">
                <div class="environment-icon">😂</div>
                <h3>Memes</h3>
                <p>Humor & viral content</p>
                <div class="environment-stats">
                    <span class="environment-id">ID: MEM006</span>
                </div>
            </div>
            
            <!-- Add New Environment Card -->
            <div class="environment-card add-new" id="addNewEnvironment">
                <div class="environment-icon">➕</div>
                <h3>Create New</h3>
                <p>Start a new chat environment</p>
            </div>
        </div>
    </div>

    <!-- Chat Interface (Hidden initially) -->
    <div class="chat-container" id="chatContainer" style="display: none;">
        <div class="chat-header">
            <button class="back-button" id="backButton">←</button>
            <div class="chat-header-content">
                <h1 id="currentEnvironmentTitle">🎭 AnonChat</h1>
                <p id="currentEnvironmentDesc">Connect anonymously with people around the world</p>
            </div>
            <div class="chat-header-info">
                <button class="info-button" id="infoButton" title="Environment Info">ℹ️</button>
            </div>
        </div>
        

        
        <div class="messages-container" id="messagesContainer">
            <div class="system-message">Welcome to AnonChat! Start chatting anonymously.</div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="Type your message..."
                maxlength="500"
                disabled
            >
            <button class="send-button" id="sendButton" disabled>
                ➤
            </button>
        </div>
    </div>

    <!-- Username Modal -->
    <div class="username-modal" id="usernameModal">
        <div class="modal-content">
            <h2>Join the Chat</h2>
            <p>Choose an anonymous username to start chatting</p>
            <input 
                type="text" 
                class="username-input" 
                id="usernameInput" 
                placeholder="Enter username..."
                maxlength="20"
            >
            <button class="join-button" id="joinButton">Join Chat</button>
        </div>
    </div>

    <!-- Create New Environment Modal -->
    <div class="create-environment-modal" id="createEnvironmentModal">
        <div class="modal-content">
            <h2>Create New Environment</h2>
            <p>Start a new chat environment</p>
            <input 
                type="text" 
                class="environment-name-input" 
                id="environmentNameInput" 
                placeholder="Environment name..."
                maxlength="30"
            >
            <textarea 
                class="environment-desc-input" 
                id="environmentDescInput" 
                placeholder="Description..."
                maxlength="100"
                rows="3"
            ></textarea>
            <div class="emoji-picker">
                <label>Choose an icon:</label>
                <div class="emoji-options" id="emojiOptions">
                    <span class="emoji-option" data-emoji="🎮">🎮</span>
                    <span class="emoji-option" data-emoji="🎵">🎵</span>
                    <span class="emoji-option" data-emoji="🎨">🎨</span>
                    <span class="emoji-option" data-emoji="🏃">🏃</span>
                    <span class="emoji-option" data-emoji="🍕">🍕</span>
                    <span class="emoji-option" data-emoji="✈️">✈️</span>
                    <span class="emoji-option" data-emoji="🎬">🎬</span>
                    <span class="emoji-option" data-emoji="📺">📺</span>
                    <span class="emoji-option" data-emoji="🎪">🎪</span>
                    <span class="emoji-option" data-emoji="🏠">🏠</span>
                    <span class="emoji-option" data-emoji="🌱">🌱</span>
                    <span class="emoji-option" data-emoji="🎯">🎯</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="cancel-button" id="cancelCreateButton">Cancel</button>
                <button class="create-button" id="createEnvironmentButton">Create Environment</button>
            </div>
        </div>
    </div>

    <!-- Environment Info Modal -->
    <div class="environment-info-modal" id="environmentInfoModal">
        <div class="environment-info-content">
            <div class="environment-info-header">
                <div class="environment-info-icon" id="infoEnvironmentIcon">🎭</div>
                <div class="environment-info-title" id="infoEnvironmentTitle">Environment</div>
            </div>
            <div class="environment-info-details">
                <div class="info-row">
                    <span class="info-label">Environment ID:</span>
                    <span class="info-value" id="infoEnvironmentId">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Description:</span>
                    <span class="info-value" id="infoEnvironmentDesc">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Created:</span>
                    <span class="info-value" id="infoEnvironmentCreated">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Messages:</span>
                    <span class="info-value" id="infoEnvironmentMessages">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Active Users:</span>
                    <span class="info-value" id="infoEnvironmentUsers">-</span>
                </div>
            </div>
            <button class="environment-info-close" id="closeInfoButton">Close</button>
        </div>
    </div>

    <script>
        class AnonymousChat {
            constructor() {
                this.currentUser = null;
                this.messages = [];
                this.isTyping = false;
                this.currentEnvironment = null;
                this.isLoggedIn = false;
                this.userProfile = null;
                this.environments = {
                    geopolitics: { 
                        id: 'GEO001', 
                        name: 'Geo Politics', 
                        icon: '🌍', 
                        desc: 'Global affairs & political discussions',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    },
                    science: { 
                        id: 'SCI002', 
                        name: 'Science', 
                        icon: '🔬', 
                        desc: 'Scientific discoveries & research',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    },
                    education: { 
                        id: 'EDU003', 
                        name: 'Education', 
                        icon: '📚', 
                        desc: 'Learning & academic discussions',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    },
                    programming: { 
                        id: 'PRO004', 
                        name: 'Programming', 
                        icon: '💻', 
                        desc: 'Code, tech & development',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    },
                    'social-media': { 
                        id: 'SOC005', 
                        name: 'Social Media', 
                        icon: '📱', 
                        desc: 'Trends & digital culture',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    },
                    memes: { 
                        id: 'MEM006', 
                        name: 'Memes', 
                        icon: '😂', 
                        desc: 'Humor & viral content',
                        created: new Date('2024-01-01'),
                        messageCount: 0,
                        activeUsers: 0
                    }
                };
                this.init();
            }

            init() {
                this.bindEvents();
                this.generateRandomUsername();
                this.simulateActivity();
                this.checkLoginStatus();
                this.checkExpiredEnvironments();
            }

            bindEvents() {
                // Environment selection events
                const environmentCards = document.querySelectorAll('.environment-card:not(.add-new)');
                const addNewButton = document.getElementById('addNewEnvironment');
                const backButton = document.getElementById('backButton');
                const createModal = document.getElementById('createEnvironmentModal');
                const cancelCreateButton = document.getElementById('cancelCreateButton');
                const createEnvironmentButton = document.getElementById('createEnvironmentButton');
                const environmentNameInput = document.getElementById('environmentNameInput');
                const environmentDescInput = document.getElementById('environmentDescInput');
                const emojiOptions = document.querySelectorAll('.emoji-option');

                // Login events
                const guestButton = document.getElementById('guestButton');
                const logoutButton = document.getElementById('logoutButton');

                // Search events
                const searchInput = document.getElementById('environmentSearch');
                const searchButton = document.getElementById('searchButton');

                // Chat events
                const joinButton = document.getElementById('joinButton');
                const usernameInput = document.getElementById('usernameInput');
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                // Info button
                const infoButton = document.getElementById('infoButton');
                const closeInfoButton = document.getElementById('closeInfoButton');

                // Environment selection
                environmentCards.forEach(card => {
                    card.addEventListener('click', () => this.selectEnvironment(card.dataset.environment));
                });

                addNewButton.addEventListener('click', () => this.showCreateEnvironmentModal());
                backButton.addEventListener('click', () => this.showEnvironmentsList());
                cancelCreateButton.addEventListener('click', () => this.hideCreateEnvironmentModal());
                createEnvironmentButton.addEventListener('click', () => this.createNewEnvironment());

                // Login functionality
                guestButton.addEventListener('click', () => this.handleGuestLogin());
                logoutButton.addEventListener('click', () => this.handleLogout());

                // Emoji selection
                emojiOptions.forEach(option => {
                    option.addEventListener('click', () => this.selectEmoji(option));
                });

                // Search functionality
                searchButton.addEventListener('click', () => this.searchEnvironments());
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchEnvironments();
                });
                searchInput.addEventListener('input', () => this.handleSearchInput());

                // Chat functionality
                joinButton.addEventListener('click', () => this.joinChat());
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinChat();
                });
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                messageInput.addEventListener('input', () => this.handleTyping());
                sendButton.addEventListener('click', () => this.sendMessage());

                // Info button events
                infoButton.addEventListener('click', () => this.showEnvironmentInfo());
                closeInfoButton.addEventListener('click', () => this.hideEnvironmentInfo());
            }

            selectEnvironment(environmentId) {
                this.currentEnvironment = environmentId;
                const environment = this.environments[environmentId];
                
                // Update chat interface
                document.getElementById('currentEnvironmentTitle').innerHTML = `${environment.icon} ${environment.name}`;
                document.getElementById('currentEnvironmentDesc').textContent = environment.desc;
                
                // Show chat interface
                document.getElementById('environmentsContainer').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
                
                // Clear previous messages and add welcome message
                document.getElementById('messagesContainer').innerHTML = '';
                this.addSystemMessage(`Welcome to ${environment.name}! Start chatting anonymously.`);
                
                // Increment active users for this environment
                if (environment.activeUsers !== undefined) {
                    environment.activeUsers++;
                }
            }

            showEnvironmentsList() {
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('environmentsContainer').style.display = 'block';
                this.currentEnvironment = null;
                this.currentUser = null;
                
                // Reset chat interface
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendButton').disabled = true;
                document.getElementById('usernameModal').style.display = 'none';
            }

            showCreateEnvironmentModal() {
                document.getElementById('createEnvironmentModal').style.display = 'flex';
                document.getElementById('environmentNameInput').focus();
                this.selectedEmoji = '🎮'; // Default emoji
            }

            hideCreateEnvironmentModal() {
                document.getElementById('createEnvironmentModal').style.display = 'none';
                document.getElementById('environmentNameInput').value = '';
                document.getElementById('environmentDescInput').value = '';
                document.querySelectorAll('.emoji-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }

            selectEmoji(emojiOption) {
                document.querySelectorAll('.emoji-option').forEach(option => {
                    option.classList.remove('selected');
                });
                emojiOption.classList.add('selected');
                this.selectedEmoji = emojiOption.dataset.emoji;
            }

            createNewEnvironment() {
                const name = document.getElementById('environmentNameInput').value.trim();
                const desc = document.getElementById('environmentDescInput').value.trim();
                
                if (!name || !desc) {
                    alert('Please fill in both name and description');
                    return;
                }

                const environmentId = 'custom-' + Date.now();
                const customId = 'CUS' + String(Date.now()).slice(-6);
                const creatorName = this.currentUser || (this.userProfile ? this.userProfile.name : 'Anonymous');
                console.log('Creating environment with creator:', creatorName);
                console.log('this.currentUser:', this.currentUser);
                console.log('this.userProfile:', this.userProfile);
                
                const newEnvironment = {
                    id: customId,
                    name: name,
                    icon: this.selectedEmoji,
                    desc: desc,
                    created: new Date(),
                    messageCount: 0,
                    activeUsers: 0,
                    creator: creatorName,
                    isCustom: true,
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours from now
                };

                this.environments[environmentId] = newEnvironment;
                this.addEnvironmentCard(environmentId, newEnvironment);
                this.hideCreateEnvironmentModal();
                
                // Auto-transfer to the new environment
                this.selectEnvironment(environmentId);
                
                // Schedule auto-deletion after 24 hours
                setTimeout(() => {
                    this.autoDeleteEnvironment(environmentId);
                }, 24 * 60 * 60 * 1000);
            }

            addEnvironmentCard(environmentId, environment) {
                const grid = document.getElementById('environmentsGrid');
                const newCard = document.createElement('div');
                newCard.className = 'environment-card';
                newCard.dataset.environment = environmentId;
                
                // Check if user is the creator
                const currentUserName = this.currentUser || (this.userProfile ? this.userProfile.name : null);
                const isCreator = environment.creator === currentUserName;
                const isCustom = environment.isCustom;
                
                console.log('Creating card for:', environment.name);
                console.log('Is custom:', isCustom);
                console.log('Is creator:', isCreator);
                console.log('Current user:', currentUserName);
                console.log('Environment creator:', environment.creator);
                
                newCard.innerHTML = `
                    <div class="environment-icon">${environment.icon}</div>
                    <h3>${environment.name}</h3>
                    <p>${environment.desc}</p>
                    <div class="environment-stats">
                        <span class="environment-id">ID: ${environment.id}</span>
                        ${isCustom ? `<span class="environment-creator">Created by: ${environment.creator}</span>` : ''}
                    </div>
                    ${isCreator && isCustom ? `<button class="delete-environment-btn" onclick="event.stopPropagation(); chatApp.deleteEnvironment('${environmentId}')" title="Delete Environment">🗑️</button>` : ''}
                `;
                
                // Insert before the "Create New" card
                const addNewCard = document.getElementById('addNewEnvironment');
                grid.insertBefore(newCard, addNewCard);
                
                // Add click event
                newCard.addEventListener('click', () => this.selectEnvironment(environmentId));
            }

            searchEnvironments() {
                const searchTerm = document.getElementById('environmentSearch').value.trim().toUpperCase();
                const resultsContainer = document.getElementById('searchResults');
                
                if (!searchTerm) {
                    resultsContainer.innerHTML = '';
                    return;
                }

                const results = [];
                
                // Search through all environments
                Object.keys(this.environments).forEach(key => {
                    const environment = this.environments[key];
                    if (environment.id.includes(searchTerm) || 
                        environment.name.toUpperCase().includes(searchTerm) ||
                        environment.desc.toUpperCase().includes(searchTerm)) {
                        results.push({ key, ...environment });
                    }
                });

                this.displaySearchResults(results);
            }

            handleSearchInput() {
                const searchTerm = document.getElementById('environmentSearch').value.trim();
                if (!searchTerm) {
                    document.getElementById('searchResults').innerHTML = '';
                }
            }

            displaySearchResults(results) {
                const resultsContainer = document.getElementById('searchResults');
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">No environments found</div>';
                    return;
                }

                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="chatApp.selectEnvironment('${result.key}')">
                        <div class="search-result-icon">${result.icon}</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${result.name}</div>
                            <div class="search-result-desc">${result.desc}</div>
                        </div>
                        <div class="search-result-id">${result.id}</div>
                    </div>
                `).join('');
            }

            deleteEnvironment(environmentId) {
                const environment = this.environments[environmentId];
                
                if (!environment) {
                    alert('Environment not found');
                    return;
                }

                // Check if user is the creator
                const currentUserName = this.currentUser || (this.userProfile ? this.userProfile.name : null);
                console.log('Trying to delete environment:', environment.name);
                console.log('Current user:', currentUserName);
                console.log('Environment creator:', environment.creator);
                console.log('Are they equal?', environment.creator === currentUserName);
                
                if (environment.creator !== currentUserName) {
                    alert(`Only the creator can delete this environment. You are: ${currentUserName}, Creator is: ${environment.creator}`);
                    return;
                }

                // Check if it's a custom environment
                if (!environment.isCustom) {
                    alert('Cannot delete base environments');
                    return;
                }

                // Confirm deletion
                if (!confirm(`Are you sure you want to delete "${environment.name}"? This action cannot be undone.`)) {
                    return;
                }

                // Remove from environments object
                delete this.environments[environmentId];

                // Remove from DOM
                const card = document.querySelector(`[data-environment="${environmentId}"]`);
                if (card) {
                    card.remove();
                }

                // If currently in this environment, go back to environments list
                if (this.currentEnvironment === environmentId) {
                    this.showEnvironments();
                }

                // Clean up Firebase data
                if (window.firebaseChat) {
                    window.firebaseChat.cleanupEnvironment(environmentId);
                }

                alert(`Environment "${environment.name}" has been deleted successfully.`);
            }

            autoDeleteEnvironment(environmentId) {
                const environment = this.environments[environmentId];
                
                if (!environment || !environment.isCustom) {
                    return; // Don't delete base environments
                }

                // Remove from environments object
                delete this.environments[environmentId];

                // Remove from DOM
                const card = document.querySelector(`[data-environment="${environmentId}"]`);
                if (card) {
                    card.remove();
                }

                // If currently in this environment, go back to environments list
                if (this.currentEnvironment === environmentId) {
                    this.showEnvironments();
                    this.addSystemMessage('This environment has expired and been automatically deleted.');
                }

                // Clean up Firebase data
                if (window.firebaseChat) {
                    window.firebaseChat.cleanupEnvironment(environmentId);
                }

                console.log(`Environment "${environment.name}" has been automatically deleted after 24 hours.`);
            }

            checkExpiredEnvironments() {
                const now = new Date();
                const expiredEnvironments = [];
                
                Object.keys(this.environments).forEach(environmentId => {
                    const environment = this.environments[environmentId];
                    if (environment.isCustom && environment.expiresAt) {
                        const expiryDate = new Date(environment.expiresAt);
                        if (now > expiryDate) {
                            expiredEnvironments.push(environmentId);
                        }
                    }
                });
                
                // Delete expired environments
                expiredEnvironments.forEach(environmentId => {
                    this.autoDeleteEnvironment(environmentId);
                });
                
                if (expiredEnvironments.length > 0) {
                    console.log(`Cleaned up ${expiredEnvironments.length} expired environments`);
                }
            }

            checkLoginStatus() {
                const savedUser = localStorage.getItem('anonchat_user');
                if (savedUser) {
                    try {
                        this.userProfile = JSON.parse(savedUser);
                        this.isLoggedIn = true;
                        this.showUserInfo();
                        this.showEnvironments();
                    } catch (error) {
                        console.error('Error parsing saved user:', error);
                        localStorage.removeItem('anonchat_user');
                        this.showLoginScreen();
                    }
                }
            }

            handleGoogleCallback(response) {
                try {
                    // Decode the JWT token
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    
                    this.userProfile = {
                        name: payload.name,
                        email: payload.email,
                        picture: payload.picture,
                        id: payload.sub,
                        loginMethod: 'google',
                        loginTime: new Date().toISOString()
                    };

                    this.isLoggedIn = true;
                    localStorage.setItem('anonchat_user', JSON.stringify(this.userProfile));
                    this.showUserInfo();
                    this.showEnvironments();
                    this.showStatus('Google login successful!', 'success');
                } catch (error) {
                    console.error('Error processing Google login:', error);
                    this.showStatus('Login failed. Please try again.', 'error');
                }
            }

            handleGuestLogin() {
                const guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                this.userProfile = {
                    name: 'Guest User',
                    email: 'guest@anonchat.com',
                    picture: 'https://via.placeholder.com/50/666666/FFFFFF?text=G',
                    id: guestId,
                    loginMethod: 'guest',
                    loginTime: new Date().toISOString()
                };

                this.isLoggedIn = true;
                localStorage.setItem('anonchat_user', JSON.stringify(this.userProfile));
                this.showUserInfo();
                this.showEnvironments();
                this.showStatus('Guest login successful!', 'success');
            }

            handleLogout() {
                this.isLoggedIn = false;
                this.userProfile = null;
                this.currentUser = null;
                this.currentEnvironment = null;
                
                localStorage.removeItem('anonchat_user');
                
                // Clear any active sessions
                if (window.google && window.google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }
                
                this.showLoginScreen();
                
                // Show logout confirmation
                setTimeout(() => {
                    alert('You have been successfully logged out.');
                }, 100);
            }

            showUserInfo() {
                const userInfo = document.getElementById('userInfo');
                const loginOptions = document.getElementById('loginOptions');
                
                document.getElementById('userAvatar').src = this.userProfile.picture;
                document.getElementById('userName').textContent = this.userProfile.name;
                document.getElementById('userEmail').textContent = this.userProfile.email;
                
                userInfo.style.display = 'flex';
                loginOptions.style.display = 'none';
            }

            showLoginScreen() {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('environmentsContainer').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'none';
                
                // Reset login UI
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('loginOptions').style.display = 'block';
            }

            showEnvironments() {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('environmentsContainer').style.display = 'block';
                document.getElementById('chatContainer').style.display = 'none';
            }

            generateRandomUsername() {
                const adjectives = ['Cool', 'Mysterious', 'Friendly', 'Clever', 'Bright', 'Swift', 'Bold', 'Quiet', 'Wise', 'Kind'];
                const nouns = ['Panda', 'Tiger', 'Eagle', 'Wolf', 'Fox', 'Bear', 'Lion', 'Owl', 'Shark', 'Falcon'];
                const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
                const randomNum = Math.floor(Math.random() * 999) + 1;
                
                document.getElementById('usernameInput').value = `${randomAdj}${randomNoun}${randomNum}`;
            }

            async joinChat() {
                const username = document.getElementById('usernameInput').value.trim();
                if (!username) return;

                this.currentUser = username;
                document.getElementById('usernameModal').style.display = 'none';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('messageInput').focus();

                // Join Firebase environment
                if (window.firebaseChat) {
                    await window.firebaseChat.joinEnvironment(this.currentEnvironment, username);
                }

                const environment = this.environments[this.currentEnvironment];
                this.addSystemMessage(`${username} joined ${environment.name}`);
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();
                
                if (!content) return;

                try {
                    // Send real message to Firebase
                    if (window.firebaseChat && window.firebaseChat.sendMessage) {
                        console.log('Sending message via Firebase:', content);
                        await window.firebaseChat.sendMessage(content);
                    } else {
                        console.log('Firebase not available, using fallback');
                        // Fallback to simulated message
                        const message = {
                            id: Date.now(),
                            username: this.currentUser,
                            content: content,
                            timestamp: new Date(),
                            isOwn: true
                        };
                        this.addMessage(message);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    // Fallback to simulated message on error
                    const message = {
                        id: Date.now(),
                        username: this.currentUser,
                        content: content,
                        timestamp: new Date(),
                        isOwn: true
                    };
                    this.addMessage(message);
                }
                
                messageInput.value = '';
            }

            addMessage(message) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.isOwn ? 'own' : ''}`;
                
                messageEl.innerHTML = `
                    <div class="message-header">
                        <span class="username">${message.username}</span>
                        <span class="timestamp">${this.formatTime(message.timestamp)}</span>
                    </div>
                    <div class="message-content">${this.escapeHtml(message.content)}</div>
                `;
                
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                this.messages.push(message);
                
                // Update environment message count
                if (this.currentEnvironment && this.environments[this.currentEnvironment]) {
                    this.environments[this.currentEnvironment].messageCount++;
                }
                
                // Keep only last 50 messages to save storage
                this.manageMessageHistory();
            }

            manageMessageHistory() {
                const maxMessages = 50;
                if (this.messages.length > maxMessages) {
                    // Remove oldest messages from DOM
                    const messagesContainer = document.getElementById('messagesContainer');
                    const messageElements = messagesContainer.querySelectorAll('.message');
                    const systemMessages = messagesContainer.querySelectorAll('.system-message');
                    
                    // Keep system messages and remove oldest regular messages
                    const totalToRemove = this.messages.length - maxMessages;
                    let removed = 0;
                    
                    for (let i = 0; i < messageElements.length && removed < totalToRemove; i++) {
                        const element = messageElements[i];
                        if (!element.classList.contains('system-message')) {
                            element.remove();
                            removed++;
                        }
                    }
                    
                    // Remove from messages array
                    this.messages = this.messages.slice(-maxMessages);
                }
            }

            addSystemMessage(content) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageEl = document.createElement('div');
                messageEl.className = 'system-message';
                messageEl.textContent = content;
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            simulateResponse() {
                const environmentResponses = {
                    geopolitics: [
                        "What are your thoughts on current global tensions?",
                        "Anyone following the latest diplomatic developments?",
                        "How do you think international relations will evolve?",
                        "Interesting perspective on foreign policy",
                        "The geopolitical landscape is changing rapidly",
                        "What's your take on economic sanctions?",
                        "Global cooperation vs national interests debate",
                        "Anyone else concerned about regional conflicts?"
                    ],
                    science: [
                        "Just read about a fascinating new discovery!",
                        "Anyone working on research projects?",
                        "What's your favorite scientific field?",
                        "The latest breakthrough in quantum physics is mind-blowing",
                        "Anyone else excited about space exploration?",
                        "What do you think about climate science?",
                        "Medical research is advancing so quickly",
                        "Anyone following the latest AI developments?"
                    ],
                    education: [
                        "What are you currently studying?",
                        "Anyone taking online courses?",
                        "What's your favorite subject to learn?",
                        "Education technology is evolving rapidly",
                        "Anyone else working on certifications?",
                        "What's your learning style?",
                        "Anyone teaching or tutoring?",
                        "What skills are you trying to develop?"
                    ],
                    programming: [
                        "What programming language are you working with?",
                        "Anyone building something interesting?",
                        "What's your favorite framework?",
                        "Just solved a tricky bug! 🐛",
                        "Anyone else learning new technologies?",
                        "What's your development setup like?",
                        "Anyone contributing to open source?",
                        "What project are you most proud of?"
                    ],
                    'social-media': [
                        "What's trending on your feed today?",
                        "Anyone else addicted to scrolling? 😅",
                        "What's your favorite social platform?",
                        "Digital detox anyone?",
                        "Anyone else concerned about privacy?",
                        "What's the latest viral trend?",
                        "Social media algorithms are wild",
                        "Anyone else taking a break from socials?"
                    ],
                    memes: [
                        "Anyone else can't stop laughing at that new meme? 😂",
                        "What's your favorite meme format?",
                        "Just discovered a hilarious new meme",
                        "Anyone else making memes?",
                        "What's the funniest thing you've seen today?",
                        "Meme culture is evolving so fast",
                        "Anyone else sharing memes with friends?",
                        "What's your go-to meme reaction?"
                    ]
                };

                const generalResponses = [
                    "Hey there! How's everyone doing?",
                    "Anyone else loving this weather?",
                    "What's your favorite movie?",
                    "Just joined! This seems cool 😊",
                    "Anyone up for a chat?",
                    "Having a great day so far!",
                    "This anonymous chat is pretty neat",
                    "Hello from across the globe! 🌍",
                    "What's everyone up to today?",
                    "Love connecting with new people",
                    "Hope everyone's having a good time!",
                    "First time here, seems friendly!",
                    "Random question: coffee or tea?",
                    "Beautiful day where I am ☀️",
                    "Anyone else procrastinating? 😅"
                ];

                let responses = generalResponses;
                if (this.currentEnvironment && environmentResponses[this.currentEnvironment]) {
                    responses = environmentResponses[this.currentEnvironment];
                }

                const usernames = [
                    'MysteryUser42', 'ChatLover99', 'FriendlyStranger', 'RandomPerson123',
                    'AnonymousHelper', 'KindSoul88', 'HappyChatter', 'WorldTraveler',
                    'NightOwl2024', 'CuriousMind', 'DigitalNomad', 'BookwormAnon'
                ];

                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                const randomUser = usernames[Math.floor(Math.random() * usernames.length)];

                const message = {
                    id: Date.now(),
                    username: randomUser,
                    content: randomResponse,
                    timestamp: new Date(),
                    isOwn: false
                };

                this.showTypingIndicator(randomUser);
                
                setTimeout(() => {
                    this.hideTypingIndicator();
                    this.addMessage(message);
                }, Math.random() * 2000 + 1000);
            }

            showTypingIndicator(username) {
                const messagesContainer = document.getElementById('messagesContainer');
                const typingEl = document.createElement('div');
                typingEl.className = 'typing-indicator';
                typingEl.id = 'typingIndicator';
                typingEl.innerHTML = `
                    <span>${username} is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                messagesContainer.appendChild(typingEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const typingEl = document.getElementById('typingIndicator');
                if (typingEl) {
                    typingEl.remove();
                }
            }

            simulateActivity() {
                // Simulate random messages
                setInterval(() => {
                    if (Math.random() > 0.7) {
                        this.simulateResponse();
                    }
                }, Math.random() * 15000 + 10000);
            }

            formatTime(date) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            handleTyping() {
                // This would send typing indicators in a real implementation
                // For demo purposes, we'll just handle the input
            }

            showEnvironmentInfo() {
                if (!this.currentEnvironment || !this.environments[this.currentEnvironment]) {
                    return;
                }

                const environment = this.environments[this.currentEnvironment];
                
                // Update info modal content
                document.getElementById('infoEnvironmentIcon').textContent = environment.icon;
                document.getElementById('infoEnvironmentTitle').textContent = environment.name;
                document.getElementById('infoEnvironmentId').textContent = environment.id;
                document.getElementById('infoEnvironmentDesc').textContent = environment.desc;
                document.getElementById('infoEnvironmentCreated').textContent = environment.created.toLocaleDateString();
                document.getElementById('infoEnvironmentMessages').textContent = environment.messageCount || 0;
                document.getElementById('infoEnvironmentUsers').textContent = environment.activeUsers || 0;
                
                // Show modal
                document.getElementById('environmentInfoModal').style.display = 'flex';
            }

            hideEnvironmentInfo() {
                document.getElementById('environmentInfoModal').style.display = 'none';
            }

            // Firebase integration methods
            addRealMessage(message) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.username === this.currentUser ? 'own' : ''}`;
                
                const timestamp = message.timestamp ? 
                    (message.timestamp.toDate ? message.timestamp.toDate() : new Date(message.timestamp)) : 
                    new Date();
                
                messageEl.innerHTML = `
                    <div class="message-header">
                        <span class="username">${message.username}</span>
                        <span class="timestamp">${this.formatTime(timestamp)}</span>
                    </div>
                    <div class="message-content">${this.escapeHtml(message.content)}</div>
                `;
                
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            updateActiveUsersCount(count) {
                // Update UI to show real user count
                const userCountElement = document.getElementById('activeUsersCount');
                if (userCountElement) {
                    userCountElement.textContent = `${count} people online`;
                }
            }

            showStatus(message, type = 'info') {
                const statusElement = document.getElementById('statusMessage');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = `status-message status-${type}`;
                    statusElement.style.display = 'block';
                    
                    // Auto-hide after 5 seconds for success/info messages
                    if (type !== 'error') {
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 5000);
                    }
                }
            }

            validateSession() {
                if (!this.isLoggedIn || !this.userProfile) {
                    return false;
                }
                
                // Check if session is still valid (e.g., not expired)
                if (this.userProfile.loginTime) {
                    const loginTime = new Date(this.userProfile.loginTime);
                    const now = new Date();
                    const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
                    
                    // Session expires after 24 hours
                    if (hoursSinceLogin > 24) {
                        this.handleLogout();
                        return false;
                    }
                }
                
                return true;
            }
        }

        // Global callback function for Google Sign-In
        function handleCredentialResponse(response) {
            if (chatApp) {
                chatApp.handleGoogleCallback(response);
            }
        }

        // Initialize Google Sign-In with config
        function initializeGoogleSignIn() {
            const gIdOnload = document.getElementById('g_id_onload');
            if (gIdOnload && config.googleClientId !== 'YOUR_GOOGLE_CLIENT_ID') {
                gIdOnload.setAttribute('data-client_id', config.googleClientId);
            }
        }

        // Initialize the chat when page loads
        let chatApp;
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initializeGoogleSignIn();
                // Small delay to ensure Firebase is loaded
                setTimeout(() => {
                    try {
                        chatApp = new AnonymousChat();
                        // Make chatApp available globally for Firebase
                        window.chatApp = chatApp;
                        console.log('Chat app initialized successfully');
                    } catch (error) {
                        console.error('Error initializing chat app:', error);
                        // Fallback initialization
                        chatApp = new AnonymousChat();
                        window.chatApp = chatApp;
                    }
                }, 100);
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });
    </script>
</body>
</html> 